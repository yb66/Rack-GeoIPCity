Rack::GeoIPCity uses the geoip gem and the GeoIP database to lookup the geographical info of a request by its IP address
The database can be downloaded from:

(Lite version) http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz, instructions are here http://www.maxmind.com/app/geolitecity.

http://www.maxmind.com/app/city for full version.

*NOTE!* If you're using the country database you'll get a different struct returned, so use the GeoIPCountry gem, rack-geoipcountry. I'd make this middleware do both but:

a) It would be slower 
b) there's already a country gem and 
c) you can do the branching yourself if you really want, but why would you?

Usage:
======

use Rack::GeoIPCity, :db => "path/to/GeoIP.dat"

By default all requests are looked up and the X\_GEOIP\_* headers are added to the request
The headers can then be read in the application
The country name is added to the request header as X\_GEOIP\_COUNTRY, eg:
X\_GEOIP\_COUNTRY: United Kingdom

The full set of GEOIP request headers is below:
X\_GEOIP\_COUNTRY\_CODE - The ISO3166-1 two-character country code, if not found set to --
X\_GEOIP\_COUNTRY\_CODE3 - The ISO3166-2 three-character country code, if not found set to --
X\_GEOIP\_COUNTRY - The ISO3166 English-language name of the country, if not found set to an empty string
X\_GEOIP\_CONTINENT if not found set to an empty string
X\_GEOIP\_REGION\_NAME if not found set to an empty string
X\_GEOIP\_CITY\_NAME if not found set to an empty string
X\_GEOIP\_POSTAL\_CODE if not found set to an empty string
X\_GEOIP\_LATITUDE if not found won't be returned as I can't think of another good return value to signify "not found"
X\_GEOIP\_LONGITUDE if not found won't be returned as I can't think of another good return value to signify "not found"
'X\_GEOIP\_DMA\_CODE' The metropolitan code (this is for the USA, see http://code.google.com/apis/adwords/docs/appendix/metrocodes.html if you're interested), default 0 for not found.
X\_GEOIP\_AREA\_CODE if not found set to an empty string
X\_GEOIP\_TIMEZONE if not found set to an empty string
X\_GEOIP\_CONTINENT - The two-character continent code, if not found set to an empty string


You can use the included Mapping class to trigger lookup only for certain requests by specifying matching path prefix in options, eg:
use Rack::GeoIPCity::Mapping, :prefix => '/video\_tracking'
The above will lookup IP addresses only for requests matching /video\_tracking etc.

MIT License - 
Originally by Karol Hosiawa ( http://twitter.com/hosiawak )
Converted to a gem by Thomas Maurer
This one by Iain Barnett